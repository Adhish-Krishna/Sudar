events {
    worker_connections 1024;
}

http {
    server {
        listen 80;
        server_name localhost;

        # Increase file upload size limit
        client_max_body_size 100M;

        # Backend API - All authentication, classrooms, students, subjects, etc.
        location /api/ {
            proxy_pass http://backend:3006/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Cookie headers
            proxy_set_header Cookie $http_cookie;
            proxy_pass_header Set-Cookie;
        }

        # RAG Service - Document ingestion and retrieval
        location /rag/ {
            proxy_pass http://rag-service:3001/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # Cookie headers
            proxy_set_header Cookie $http_cookie;
            proxy_pass_header Set-Cookie;
        }

        # Sudar Agent - AI chat and workflows
        location /agent/ {
            proxy_pass http://sudar-agent:3005/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # Cookie headers
            proxy_set_header Cookie $http_cookie;
            proxy_pass_header Set-Cookie;
            
            # SSE support for streaming responses
            proxy_buffering off;
            proxy_cache off;
            proxy_read_timeout 86400s;
            proxy_send_timeout 86400s;
            chunked_transfer_encoding on;
        }

        # Health check endpoint
        location /health {
            access_log off;
            return 200 "Nginx proxy is healthy\n";
            add_header Content-Type text/plain;
        }

        # Root endpoint
        location = / {
            return 200 '{"service":"Sudar Platform","status":"running","version":"1.0.0","endpoints":{"/api":"Backend API","/rag":"RAG Service","/agent":"AI Agent"}}\n';
            add_header Content-Type application/json;
        }
    }
}
