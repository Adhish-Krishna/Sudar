# Use Python 3.11 slim image
FROM python:3.11-slim

# Set working directory
WORKDIR /app

# Set environment variables
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# Install UV
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

# Copy project files
COPY pyproject.toml ./
COPY src ./src

# Install dependencies
RUN uv pip install --system -e .

# Create non-root user
RUN useradd -m -u 1000 sudaruser && chown -R sudaruser:sudaruser /app

# Switch to non-root
USER sudaruser

ARG MODEL_PROVIDER
ARG GOOGLE_MODEL
ARG GOOGLE_API_KEY
ARG GROQ_API_KEY
ARG GROQ_MODEL
ARG OLLAMA_MODEL
ARG RAG_SERVICE_URL
ARG MCP_TOOLS_URL
ARG MD_TO_PDF_URL
ARG MONGODB_URL
ARG MONGODB_DATABASE
ARG MONGODB_COLLECTION
ARG QDRANT_HOST
ARG QDRANT_PORT
ARG QDRANT_COLLECTION_SHORT_TERM
ARG QDRANT_COLLECTION_LONG_TERM
ARG OLLAMA_BASE_URL
ARG EMBEDDING_MODEL
ARG EMBEDDING_DIMENSION
ARG HOST
ARG PORT
ARG SECRET_KEY
ARG DATABASE_URL

ENV MODEL_PROVIDER=${MODEL_PROVIDER}
ENV GOOGLE_MODEL=${GOOGLE_MODEL}
ENV GOOGLE_API_KEY=${GOOGLE_API_KEY}
ENV GROQ_API_KEY=${GROQ_API_KEY}
ENV GROQ_MODEL=${GROQ_MODEL}
ENV OLLAMA_MODEL=${OLLAMA_MODEL}
ENV RAG_SERVICE_URL=${RAG_SERVICE_URL}
ENV MCP_TOOLS_URL=${MCP_TOOLS_URL}
ENV MD_TO_PDF_URL=${MD_TO_PDF_URL}
ENV MONGODB_URL=${MONGODB_URL}
ENV MONGODB_DATABASE=${MONGODB_DATABASE}
ENV MONGODB_COLLECTION=${MONGODB_COLLECTION}
ENV QDRANT_HOST=${QDRANT_HOST}
ENV QDRANT_PORT=${QDRANT_PORT}
ENV QDRANT_COLLECTION_SHORT_TERM=${QDRANT_COLLECTION_SHORT_TERM}
ENV QDRANT_COLLECTION_LONG_TERM=${QDRANT_COLLECTION_LONG_TERM}
ENV OLLAMA_BASE_URL=${OLLAMA_BASE_URL}
ENV EMBEDDING_MODEL=${EMBEDDING_MODEL}
ENV EMBEDDING_DIMENSION=${EMBEDDING_DIMENSION}
ENV HOST=${HOST}
ENV PORT=${PORT}
ENV SECRET_KEY=${SECRET_KEY}
ENV DATABASE_URL=${DATABASE_URL}

# Expose port
EXPOSE ${PORT}

# Run the server
CMD ["python", "-m", "sudar_agent.main"]
